name: Build and Deploy to Production

on:
  push:
    branches:
      - production
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: '22'

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better git operations

      - name: Deploy to Staging via SFTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.SIERRA_SFTP_HOST }}
          username: ${{ secrets.SIERRA_PRODUCTION_SFTP_USERNAME }}
          password: ${{ secrets.SIERRA_PRODUCTION_SFTP_PASSWORD }}
          port: ${{ secrets.SIERRA_SFTP_PORT }}
          protocol: ftps
          # Plugin deployment path (e.g., /path/to/wp-content/plugins/responsive-video-cover/)
          server-dir: ${{ secrets.SIERRA_SFTP_REMOTE_PATH_PLUGIN }}

          # Exclude development files and source code
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/src/**
            **/README.md
            **/CLAUDE.md
            **/.DS_Store
            **/.env*
            **/package.json
            **/package-lock.json
            **/composer.json
            **/composer.lock
            **/webpack.config.js
            **/tsconfig.json
            **/.eslintrc*
            **/.prettierrc*
            **/tests/**
            **/__tests__/**
            **/*.test.js
            **/*.spec.js
            .github/**
            .vscode/**

          log-level: verbose

      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Successfully deployed responsive-video-cover plugin to staging!"
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üî® Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs above for details."
